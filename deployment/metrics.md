## Metrics

These deployment scripts can optionally configure the exporting a range of metrics from each Knfsd Node into [Google Cloud Operations](https://cloud.google.com/products/operations) (formerly Stackdriver). These are exported via the [Stackdriver Monitoring Agent](https://cloud.google.com/monitoring/agent) which is installed as part of the [build scripts](/image).

These metrics can be enabled via the `ENABLE_STACKDRIVER_METRICS` Terraform Variable as detailed below. **If you wish to use auto-scaling then metrics must be enabled**.

The following additional prerequisites must be met if you wish to enable metrics:

| Prerequisite                                                                                                             | Details                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [Metric Descriptors and Dashboard Import](metrics)                                                                       | If this is the first time you are deploying Knfsd in a Google Cloud Project you need to setup the Metric Descriptors and import the Knfsd Monitoring Dashboard. This is achieved via a standalone Terraform configuration and the process is described in the [metrics](metrics) directory.                                                                                                                                                                                                                                                                                                                                                                      |
| [Private Google Access](https://cloud.google.com/vpc/docs/configure-private-google-access)                               | You must have [Private Google Access](https://cloud.google.com/vpc/docs/configure-private-google-access) enabled on the subnet that you will be using for the Knfsd Nodes. This is required to allow connectivity to the Monitoring API for VM's without a Public IP.                                                                                                                                                                                                                                                                                                                                                                                            |
| [Service Account Permissions](https://cloud.google.com/compute/docs/access/service-accounts#service_account_permissions) | A Service Account needs to be configured for the Knfsd Nodes with the `logging-write` and `monitoring-write` scopes. This is performed automatically by the Terraform Module when you have metrics enabled. By default, the [Compute Engine Default Service Account](https://cloud.google.com/compute/docs/access/service-accounts#default_service_account) will be used. <br><br>You need to make sure the Service Account you create for Terraform has the `roles/iam.serviceAccountUser` role on the Compute Engine Default Service Account so that it can assign it to the Knfsd Nodes. This is covered in the "Generating a Service Account" section below. |

The following custom metrics are exported currently:

| Metric Name                                                    | Description                                                                                                     |
| -------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| **custom.googleapis.com/knfsd/nfs_connections**                | The number of NFS Clients connected to the Knfsd filer (used for autoscaling).                                  |
| **custom.googleapis.com/knfsd/nfs_inode_cache_active_objects** | The number of active objects in the Linux NFS inode Cache.                                                      |
| **custom.googleapis.com/knfsd/dentry_cache_active_objects**    | The number of active objects in the Linux Dentry Cache.                                                         |
| **custom.googleapis.com/knfsd/nfs_inode_cache_objsize**        | The total size of the objects in the Linux NFS inode Cache in bytes.                                            |
| **custom.googleapis.com/knfsd/dentry_cache_objsize**           | The total size of the objects in the Linux Dentry Cache in bytes.                                               |
| **custom.googleapis.com/knfsd/nfsiostat_mount_read_exe**       | The average read operation EXE per NFS client mount over the past 60 seconds (Knfsd --> Source Filer).          |
| **custom.googleapis.com/knfsd/nfsiostat_mount_read_rtt**       | The average read operation RTT per NFS client mount over the past 60 seconds (Knfsd --> Source Filer).          |
| **custom.googleapis.com/knfsd/nfsiostat_mount_write_exe**      | The average write operation EXE per NFS client mount over the past 60 seconds (Knfsd --> Source Filer).         |
| **custom.googleapis.com/knfsd/nfsiostat_mount_write_rtt**      | The average write operation RTT per NFS client mount over the past 60 seconds (Knfsd --> Source Filer)..        |
| **custom.googleapis.com/knfsd/nfsiostat_ops_per_second**       | The number of NFS operations per second per NFS client mount over the past 60 seconds (Knfsd --> Source Filer). |
| **custom.googleapis.com/knfsd/nfsiostat_rpc_backlog**          | The RPC Backlog per NFS client mount over the past 60 seconds (Knfsd --> Source Filer).                         |

### Dashboards

The Knfsd Monitoring Dashboard is created automatically by the metrics initialisation Terraform that is detailed in the [Metrics Prerequisites](#metrics).

Once ran, you can then access the dashboard from [https://console.cloud.google.com/monitoring/dashboards/](https://console.cloud.google.com/monitoring/dashboards/)
